name: AI PR Review (MVP, no secrets)

on:
  pull_request:
    types: [opened, reopened]

jobs:
  ai_review:
    runs-on: ubuntu-latest
    steps:
      - name: Gather PR metadata
        id: meta
        run: |
          echo "pr_number=${{ github.event.pull_request.number }}" >> $GITHUB_OUTPUT
          echo "repo=${{ github.repository }}" >> $GITHUB_OUTPUT
          echo "author=${{ github.event.pull_request.user.login }}" >> $GITHUB_OUTPUT
          echo "additions=${{ github.event.pull_request.additions }}" >> $GITHUB_OUTPUT
          echo "deletions=${{ github.event.pull_request.deletions }}" >> $GITHUB_OUTPUT
          echo "changed_files=${{ github.event.pull_request.changed_files }}" >> $GITHUB_OUTPUT

      - name: Fetch PR diff (truncated)
        id: diff
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
          REPO: ${{ github.repository }}
        run: |
          PR="${{ github.event.pull_request.number }}"
          DIFF_URL="https://api.github.com/repos/${REPO}/pulls/${PR}"
          DIFF=$(curl -sS -H "Accept: application/vnd.github.v3.diff" -H "Authorization: Bearer $GITHUB_TOKEN" "$DIFF_URL")
          TRUNC="${DIFF:0:20000}"
          echo "::set-output name=diff::${TRUNC}"

      - name: Call Render AI service (no secret)
        env:
          RENDER_AI_URL: "https://ai-repo-supervisor-agentic.onrender.com"
        run: |
          BASE="${RENDER_AI_URL%/}"
          ENDPOINT="$BASE/analyze-pr"
          PAYLOAD=$(jq -n \
            --arg repo "${{ steps.meta.outputs.repo }}" \
            --argjson pr_number ${{ steps.meta.outputs.pr_number }} \
            --arg author "${{ steps.meta.outputs.author }}" \
            --argjson additions ${{ steps.meta.outputs.additions }} \
            --argjson deletions ${{ steps.meta.outputs.deletions }} \
            --argjson changed_files ${{ steps.meta.outputs.changed_files }} \
            --arg diff "${{ steps.diff.outputs.diff }}" \
            '{repo:$repo,pr_number:$pr_number,author:$author,additions:$additions,deletions:$deletions,changed_files:$changed_files,diff:$diff,lint_passed:false}')
          echo "Posting to $ENDPOINT (diff_len=$(echo "$PAYLOAD" | jq -r '.diff|length'))"
          set +e
          HTTP_CODE=$(curl -s -o response.json -w "%{http_code}" -X POST "$ENDPOINT" \
            -H "Content-Type: application/json" \
            -d "$PAYLOAD")
          CURL_EXIT=$?
          set -e
          echo "curl exit: $CURL_EXIT http_code: $HTTP_CODE"
          if [ "$CURL_EXIT" -ne 0 ] || [ -z "$HTTP_CODE" ] || [ "$HTTP_CODE" -ge 400 ]; then
            echo "Request failed or returned HTTP $HTTP_CODE"
            if [ -s response.json ]; then
              echo "Response body:"
              cat response.json
            else
              echo "{}" > response.json
              echo "Empty response saved as {} to response.json"
            fi
          else
            echo "Successful response (HTTP $HTTP_CODE):"
            cat response.json
          fi

      - name: Comment on PR with AI summary (always attempt)
        if: always()
        env:
          GITHUB_TOKEN: ${{ secrets.GITHUB_TOKEN }}
        run: |
          # prefer server-provided comment field
          COMMENT=$(jq -r '.comment // empty' response.json || true)
          if [ -z "$COMMENT" ]; then
            SUMMARY=$(jq -r '.summary // "No summary returned."' response.json)
            PR_SCORE=$(jq -r '.pr_score // "unknown"' response.json)
            COMMENT="**AI review (MVP)**\n\nScore: \`${PR_SCORE}\`\n\nSummary:\n\n${SUMMARY}"
          fi
          echo "Posting comment to PR #${{ github.event.pull_request.number }} (comment length=$(echo "$COMMENT" | wc -c))"
          # POST and show HTTP status / response for debugging
          set +e
          HTTP_CODE=$(curl -s -o gh_response.json -w "%{http_code}" -H "Authorization: Bearer $GITHUB_TOKEN" -X POST \
            -d "$(jq -nc --arg body "$COMMENT" '{body:$body}')" \
            "https://api.github.com/repos/${{ github.repository }}/issues/${{ github.event.pull_request.number }}/comments")
          CURL_EXIT=$?
          set -e
          echo "gh curl exit: $CURL_EXIT http_code: $HTTP_CODE"
          if [ "$CURL_EXIT" -ne 0 ] || [ -z "$HTTP_CODE" ] || [ "$HTTP_CODE" -ge 400 ]; then
            echo "Failed to post GitHub comment (HTTP $HTTP_CODE)"
            if [ -s gh_response.json ]; then
              echo "GitHub response:"
              cat gh_response.json
            fi
            # still succeed the job (we don't want workflow to block on comment failures)
          else
            echo "Comment posted successfully (HTTP $HTTP_CODE)"
            cat gh_response.json
          fi